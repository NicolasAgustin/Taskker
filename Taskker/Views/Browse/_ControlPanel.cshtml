@using Taskker.Models
@using Taskker.Models.DAL
@model Grupo

<style>
    .dropdown-content {
        width: 200px !important;
    }

    .theme-colour {
        background-color: #d96d6d !important;
    }
</style>

<!-- Modal Structure -->
<div class="modal-content" id="panel-group">
    <h4>Panel de control para @Model.Nombre</h4>
    @Html.ValidationSummary(false, "", new { @style = "color:red;font-weight:bold" })
    @using (Html.BeginForm("ControlPanel", "Browse", FormMethod.Post, new { @class = "col s12", @id = "control-panel-form" }))
    {
        <!-- Titulo -->
        int i = 0;
        foreach (var user in Model.Usuarios)
        {
            <div class="row" row-index="@user.ID">
                <!-- Nombre del usuario -->
                <div class="col-s4">
                    <a>@user.NombreApellido</a>
                    <input type="hidden" value="@user.ID" name="usuarios[@i].ID" />
                </div>

                <!-- Cambiar rol del usuario -->
                <div class="input-field col s4">
                    <select name="usuarios[@i].Roles" multiple>
                        @foreach (var rol in (List<Rol>)ViewData["roles"])
                        {
                            if (user.Roles.FirstOrDefault(r => r.ID == rol.ID) != null)
                            {
                                <option value="@rol.Nombre" selected>@rol.Nombre</option>
                            }
                            else
                            {
                                <option value="@rol.Nombre">@rol.Nombre</option>
                            }
                        }
                    </select>
                    <label>Seleccionar rol</label>
                </div>

                <!-- Eliminar usuario del grupo -->
                <div class="col-s4">
                    @*@Url.Action("DeleteUserFromGroup", "Groups", new { groupid = Model.ID, userid = user.ID})*@
                    <a href="#"
                       class="btn waves-effect waves-light btn-eliminar"
                       data-index="@user.ID">
                        Eliminar
                        <i class="material-icons right">clear</i>
                    </a>
                </div>
            </div>
            i++;
        }
    }
</div>
<div class="modal-footer">
    <a href="#!" class="modal-close waves-effect waves-green btn-flat theme-colour">Close</a>
</div>

<script>
    $(document).ready(function () {
        var elems = document.querySelectorAll('select');
        M.FormSelect.init(elems);

        $('.btn-eliminar').on('click', function (elem) {
            var userId = elem.target.getAttribute("data-index");
            var groupId = @Model.ID;

            $.ajax({
                url: "/Groups/DeleteUserFromGroup",
                type: 'GET',
                data: { groupid: groupId, userid: userId },
                success: function (data) {
                    var form = document.getElementById("control-panel-form")
                    var children = form.children;
                    for (var i = 0; i < children.length; i++) {
                        var child = children[i];
                        if (child.getAttribute("row-index") == userId) {
                            child.remove();
                            break;
                        }
                    }
                }
            });
        })
    })
</script>
