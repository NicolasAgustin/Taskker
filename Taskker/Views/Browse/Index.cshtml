@using Taskker.Models
@using Taskker.Models.DAL

@model Grupo

@{
    var session = Session["UserSession"] as UserSession;
    var email = session.Email;
    var picture = session.EncodedPicture;
    var nombre = session.NombreApellido;
    var gruposNombres = (List<string>)Session["Grupos"];
}

@section scripts{
    @Scripts.Render("~/Scripts/jquery-3.4.1.min.js")
    @Scripts.Render("~/Scripts/download_report.js")
}

<style>
    tr {
        background-color: rgba(0, 0, 0, 0.45);
        border-radius: 5px;
    }

    th {
        background-color: #d96d6d !important;
    }

    .theme-colour {
        background-color: #d96d6d !important;
    }

    .control-color {
        color: white !important;
    }
</style>

<script>

    // Inicializamos el modal
    document.addEventListener('DOMContentLoaded', function () {
        var elems = document.querySelectorAll('#details');
        M.Modal.init(
            elems,
            {
                preventScrolling: true
            }
        );

        var elems2 = document.querySelectorAll('#control-panel');
        M.Modal.init(
            elems2,
            {
                preventScrolling: true
            }
        );
    });

</script>

<script>
    $(document).ready(function () {

        $('#details').modal({
            onOpenStart: function (modal, trigger) {
                $.ajax({
                    url: "/Browse/TaskDetails",
                    type: 'GET',
                    data: { titulo: trigger.children[0].textContent },
                    success: function (data) {
                        $("#details").html(data);
                    }
                });
            },

            onCloseStart: function (modal, trigger) {
                document.getElementById('update-form').submit()
            }
        });

        $('#control-panel').modal({
            onOpenStart: function (modal, trigger) {
                $.ajax({
                    url: "/Browse/ControlPanel",
                    type: 'GET',
                    success: function (data) {
                        $("#control-panel").html(data);
                    }
                });
            },

            onCloseStart: function (modal, trigger) {
                document.getElementById('control-panel-form').submit()
            }
        });
    })
</script>

<script>
    $(document).ready(function () {
        $('#create').modal({
            onOpenStart: function (modal, trigger) {
                $.ajax({
                    type: 'GET',
                    url: "/Browse/CreateTask",
                    success: function (data) {
                        $("#create").html(data);
                    }
                });
            },
            onOpenEnd: function (modal, trigger) {
            }
        })
    })

    $(document).ready(function () {
        $('#add-task').on('click', function () {
            M.Modal.getInstance($("#create")).open()
        });
    });

    $(document).ready(function () {
        $('#pcontrol').on('click', function () {
            M.Modal.getInstance($("#control-panel")).open()
        });
    });

</script>

<nav>
    <div class="nav-wrapper">
        <a href="@Url.Action("Index", "Home")" class="brand-logo">Taskker</a>
    </div>
</nav>

@Html.Partial("_Menu")

<div class="row">
    <div style="margin-left: 15px !important">
        <i class="medium material-icons left control-color">group</i>
        <h2 class="control-color">@Model.Nombre</h2>
    </div>
</div>

<div class="row">

    <a href="#" data-target="slide-out" class="sidenav-trigger waves-effect waves-light btn theme-colour">
        <i class="small material-icons left">menu</i>Menu
    </a>

    @if (((List<string>)ViewData["Roles"]).Contains("Project Manager"))
    {

        <a class="waves-effect waves-light btn modal-trigger theme-colour" data-target="create" id="add-task">
            <i class="small material-icons left">add</i>Crear tarea
        </a>

        <a class="waves-effect waves-light btn modal-trigger theme-colour" data-target="control-panel" id="pcontrol">
            <i class="small material-icons left">business_center</i>Panel de control
        </a>
    }

    <a class="waves-effect waves-light btn theme-colour" id="download-report" href="@Url.Action("DownloadReport", "Report")">
        <i class="small material-icons left">insert_chart</i>Descargar reporte de horas
    </a>

</div>

<!-- Modal Trigger -->
<div id="details" class="modal">
</div>

<div id="create" class="modal">
</div>

<div id="control-panel" class="modal">
</div>

<div class="row">
    <table class="highlight">
        <thead>
            <tr>
                <th class="control-color">Titulo</th>
                <th class="control-color">Tipo</th>
                <th class="control-color">Estimado</th>
                <th class="control-color">Tiempo total registrado</th>
            </tr>
        </thead>

        <tbody>
            @{
                foreach (var tarea in Model.Tareas)
                {
                    DateTime total = new DateTime(2023, 1, 1, 0, 0, 0);
                    List<DateTime> tiempos = tarea.TiempoRegistrado.Select(t => t.Time).ToList();

                    if (tiempos.Count != 0)
                    {
                        total = tiempos.Aggregate((prev, next) => 
                            prev.AddMinutes(next.Minute).AddHours(next.Hour).AddSeconds(next.Second)
                        );
                    }

                    <tr data-target="details" class="modal-trigger">
                        <td class="control-color">@tarea.Titulo</td>
                        <td class="control-color">@tarea.Tipo.ToString()</td>
                        <td class="control-color">@tarea.Estimado.ToString("HH:mm")</td>
                        <td class="control-color">@total.ToString("HH:mm")</td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>
